# Taobao File System

互联网应用经常需要存储用户上传的文档、图片、视频等，比如Facebook相册、淘宝图片、Dropbox文档等。  
文档、图片、视频一般称为Blob数据，存储Blob数据的文件系统也相应的称为Blob存储系统。每个Blob数据一般都比较大，而且多个Blob之间没有关联。Blob文件系统的特点是写入后基本都是只读，很少出现更新操作。

TFS架构设计时需要考虑如下两个问题：
* Metadata信息存储。  
  由于图片数量巨大，单机存放不了所有的元数据信息，假设每个图片文件的元数据占用100字节，100亿图片的元数据占用的空间为10Gx0.1KB=1TB,单台机器无法提供元数据服务。

* 减少图片读取的IO次数。
  在普通的Linux文件系统中，读取一个文件包括三次磁盘IO:首先读取目录元数据到内存，其次把文件的inode节点装载到内存，最后读取实际的文件内容。由于小文件个数太多，无法将所有目录及文件的inode信息缓存到内存，因此磁盘IO次数很难达到每个图片读取只需要一次磁盘IO的理想状态。

因此，TFS设计时采用的思路是：<u>多个逻辑图片文件共享一个物理文件。</u>

## 系统架构
在TFS中，将大量的小文件（实际数据文件）合并成一个大文件，这个大文件称为块（Block)，每个Block拥有在集群内唯一的编号（块ID)，通过＜块ID,块内偏移＞可以唯一确定一个文件。TFS中Block的实际数据都存储在DataServer中，大小一般为64MB,默认存储三份，相当于GFS中的chunk。应用客户端是TFS提供给应用程序的访问接口，应用客户端不缓存文件数据，只缓存NameServer的元数据。  

TFS NameServer和GFS Master相比，最大的不同之处就是不需要保存文件目录树信息，也不需要维护文件和Block之间的映射关系。

## 讨论
图片应用中有几个问题，第一个问题是图片去重，第二个问题是图片更新与删除。  

由于用户可能上传大量相同的图片，因此，图片上传到TFS前，需要去重。一般在外部维护一套文件级别的去重系统（Dedup),采用MD5或者SHA1等Hash算法为图片文件计算指纹（FingerPrint).图片写入TFS之前首先到去重系统中查找是否存在指纹，如果已经存在，基本可以认为是重复图片；图片写入TFS以后也需要将图片的指纹以及在TFS中的位置信息保存到去重系统中。去重是一个键值存储系统，淘宝内部使用5.2节中的Tair来进行图片去重。

图片的更新操作是在TFS中写入新图片，并在应用系统的数据库中保存新图片的位置，图片的删除操作仅仅在应用系统中将图片删除。图片在TFS中的位置是通过＜Block id,Block offset>标识的，且Block偏移是在Block文件中的物理偏移，因此，每个Block中只要还有一个有效的图片文件就无法回收，也无法对Block文件进行重整。如果系统的更新和删除比较频繁，需要考虑磁盘空间的回收，这点会在Facebook Haystack 系统中具体说明。